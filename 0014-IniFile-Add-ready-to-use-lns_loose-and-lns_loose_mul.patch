From 1fe83c959f77a744c989b53b3b72b914b9cd1f02 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Rapha=C3=ABl=20Pinson?= <raphael.pinson@camptocamp.com>
Date: Thu, 10 Jan 2013 11:09:59 +0100
Subject: [PATCH] IniFile: Add ready-to-use lns_loose and lns_loose_multiline
 lenses

(cherry picked from commit 96042e5e02cf5b8a302e5cb4c2e2ae9931205d18)
---
 lenses/inifile.aug            | 44 ++++++++++++++++++++++++++++++++++++++++++-
 lenses/tests/test_inifile.aug | 33 ++++++++++++++++++++++++++++++++
 2 files changed, 76 insertions(+), 1 deletion(-)

diff --git a/lenses/inifile.aug b/lenses/inifile.aug
index 9d3f141..fca22eb 100644
--- a/lenses/inifile.aug
+++ b/lenses/inifile.aug
@@ -369,7 +369,7 @@ let record (title:lens) (entry:lens)
 
 
 (************************************************************************
- * Group:                      LENS
+ * Group:                      GENERIC LENSES
  *************************************************************************)
 
 
@@ -405,3 +405,45 @@ let lns (record:lens) (comment:lens)
                        = lns_noempty record (comment|empty)
 
 
+(************************************************************************
+ * Group:                   READY-TO-USE LENSES
+ *************************************************************************)
+
+let record_anon (entry:lens) = [ label "section" . value ".anon" . ( entry | empty )+ ]
+
+(*
+View: lns_loose
+  A loose, ready-to-use lens, featuring:
+    - sections as values (to allow '/' in names)
+    - support empty lines and comments
+    - support for [#;] as comment, defaulting to ";"
+    - .anon sections
+    - don't allow multiline values
+    - allow indented titles
+    - allow indented entries
+*)
+let lns_loose = 
+     let l_comment = comment comment_re comment_default
+  in let l_sep = sep sep_re sep_default
+  in let l_entry = indented_entry entry_re l_sep l_comment
+  in let l_title = indented_title_label "section" (record_label_re - ".anon")
+  in let l_record = record l_title l_entry
+  in (record_anon l_entry)? . l_record*
+
+(*
+View: lns_loose_multiline
+  A loose, ready-to-use lens, featuring:
+    - sections as values (to allow '/' in names)
+    - support empty lines and comments
+    - support for [#;] as comment, defaulting to ";"
+    - .anon sections
+    - allow multiline values
+*)
+let lns_loose_multiline = 
+     let l_comment = comment comment_re comment_default
+  in let l_sep = sep sep_re sep_default
+  in let l_entry = entry_multiline entry_re l_sep l_comment
+  in let l_title = title_label "section" (record_label_re - ".anon")
+  in let l_record = record l_title l_entry
+  in (record_anon l_entry)? . l_record*
+
diff --git a/lenses/tests/test_inifile.aug b/lenses/tests/test_inifile.aug
index 128ad63..4c97ac3 100644
--- a/lenses/tests/test_inifile.aug
+++ b/lenses/tests/test_inifile.aug
@@ -335,3 +335,36 @@ ticket_243 = \"value1;value2#value3\" # end of line comment
     { "3" = "val3" }
   }
 
+  (* Test: IniFile.lns_loose *)
+  test IniFile.lns_loose get conf_ace =
+  { "section" = ".anon"
+    { "#comment" = "comment with sharp" }
+    {  }
+  }
+  { "section" = "section1"
+    { "test_ace" = "value"
+      { "#comment" = "end of line comment" }
+    }
+    { "test_ace" }
+    { "#comment" = "comment with colon" }
+    {  }
+  }
+
+  (* Test: IniFile.lns_loose_multiline *)
+  test IniFile.lns_loose_multiline get conf_ace =
+  { "section" = ".anon"
+    { "#comment" = "comment with sharp" }
+    {  }
+  }
+  { "section" = "section1"
+    { "test_ace" = "value"
+      { "#comment" = "end of line comment" }
+    }
+    { "test_ace" }
+    { "#comment" = "comment with colon" }
+    {  }
+  }
+  
+  test IniFile.lns_loose_multiline get multiline_test =
+      { "section" = ".anon" { "test_ace" = "val1\n  val2\n   val3" } }
+
